# ADR 0003：自动生成预览图需要“首次授权”（记住选择）

## 背景

在 `desktop-mvp-foundation`（Phase A）里，“生成方案”之后会触发一组图片生成任务（预览图），以便用户快速对齐风格、筛选方向、继续迭代。

但这类“自动触发的额外生图”存在明确成本与风险：

- **额度/费用**：调用外部模型会消耗 token/credits/计费额度（即使用户只点了“生成方案”）
- **时间与资源**：批量任务会占用时间、CPU/磁盘空间、并增加任务队列负担
- **信任**：如果用户第一次使用就被“悄悄扣费/跑了一堆图”，很容易直接不再使用

同时用户偏好是“更自动化、更省事”，但要求“极简 UI + 信息密度 + 不做教学式引导”。因此需要一个低打扰、一次性决策的授权机制。

## 选项

1. 选项 A：不做授权，默认自动生成（封面+N 或 全部）
   - 优点：最省事
   - 缺点：高信任风险；额度争议最大；第一次体验容易翻车

2. 选项 B：**首次触发前弹一次确认（记住选择）**（本 ADR 选择）
   - 优点：一次性建立预期；之后可以自动化；符合“极简但可控”
   - 缺点：首次会多一个弹窗；需要落一个设置项

3. 选项 C：永远不自动，只提供手动按钮
   - 优点：最可控
   - 缺点：背离“自动化省事”，且会让流程变长（用户每次都要手点）

## 决策

选择 **选项 B：首次触发前弹一次确认，并可记住选择**。

### 什么是“首次授权”

这里的“首次授权”特指：

- 当系统**第一次**准备在用户未明确点击“生成预览图”的情况下，自动创建一批“预览图生成任务”时
- 弹出一个极简确认窗，让用户选择“自动生成策略”，并决定是否记住该选择
- 一旦用户选择并“记住”，后续就按该策略自动执行，不再重复询问（用户可在设置里修改）

### 触发时机（推荐）

- 触发点：`生成方案`成功之后、开始创建预览图任务之前
- 如果用户选择“否/关闭自动生成”，则本次不创建任何预览图任务，但在方案页保留手动入口（例如 `生成预览图` 按钮）

### 弹窗内容（信息密度优先，避免教学）

弹窗必须包含（尽量一屏内）：

- 本次将生成的数量：例如 `封面 + 前 N 张（共 {n} 张）`
- 将使用的模型（若可得）：例如 `imageModel = xxx`
- 风险提示一句话：`可能消耗额度/费用，并占用本地空间`
- 选项（最小 3 个）：
  - `不自动生成`
  - `封面 + 前 N 张`（MVP 默认 `N=3`；**N 不含封面**，即“封面 + 额外 3 张”，总计最多 4 张）
  - `全部场景`
- `记住选择`（默认开启）
- `可在 设置 > AI/生成 > 预览图 中修改`（一行链接/提示，不展开说明）

## 后果

- 正面影响：
  - 把“自动化的代价”在第一次就讲清楚，降低信任风险
  - 之后仍然可以保持高自动化与极简 UI（不需要每次确认）
  - 形成可扩展模式：未来其它“自动触发但有成本”的动作也可复用同一授权方式

- 负面影响 / 代价：
  - 需要在本地设置里存一个策略值（以及未来可能的 N）
  - 需要一个确认窗与设置入口（但一次性）

- 对现有代码/数据的迁移要求：
  - 建议存到 Sidecar `settings`：
    - `auto_preview_images_policy`: `"off" | "cover_plus_n" | "all"`
    - （可选）`auto_preview_images_n`: number
  - 方案生成完成后创建任务前，若 policy 为空/未设置，则弹首次授权；policy 已设置则直接按策略创建任务
