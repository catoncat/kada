# ADR 0005：任务队列保留完整历史；失败任务支持“重试（创建新任务）”

## 背景

Phase A 里，生成方案、批量预览图、图片编辑/生成都将通过 Sidecar 的 `tasks` 队列异步执行。

用户明确要求：

- 任务队列需要保留 **失败** 与 **完整历史任务**
- 任务需要支持 **重试**

这实际上是在定义：任务队列不仅是“进行中进度条”，也是桌面应用里可追溯的“操作日志”。

## 选项

1. 选项 A：只显示/只保留 active tasks（pending/running），完成就清掉
   - 优点：UI 简单
   - 缺点：失败恢复路径断；用户错过 toast 后找不到原因；不符合“完整历史”的要求

2. 选项 B：保留失败任务；成功任务短期保留（例如最近 50 条/7 天）
   - 优点：兼顾恢复与体积
   - 缺点：不满足“完整历史”的要求；时间久了追溯会丢

3. 选项 C：**保留完整历史任务；失败任务可重试**（本 ADR 选择）
   - 优点：最可追溯；桌面端体验更像“操作系统日志”
   - 缺点：需要提供筛选/搜索，否则信息会堆积；需要定义重试的历史保留方式

## 决策

选择 **选项 C：保留完整历史任务；失败任务支持重试**。

### 保留策略

- Sidecar `tasks` 表默认不自动删除任何任务记录（作为审计/追溯日志）
- UI 的任务抽屉提供最小筛选：
  - `进行中`（pending/running）
  - `失败`（failed）
  - `全部`（all）

### 重试语义（必须保留历史）

为了满足“完整历史”，重试不能通过“重置原任务”来实现（否则会覆盖/丢失原失败记录与错误）。

重试推荐语义：

- 用户在失败任务上点击 `重试`
- 系统 **创建一条新任务记录**（new task id），复制原任务的 `type + input + relatedId/relatedMeta`
- 新任务增加一个“关联字段”指向原任务（推荐新增 `retryOfTaskId`；若不想改 schema，至少在 `relatedMeta` 或 `input` 中记录 `retryOf`)
- 原失败任务保持不变（保留 error/output/时间），用于追溯

> 可选增强：同一个任务链路显示“第 1 次/第 2 次尝试”，并在详情里展示原任务错误。

## 后果

- 正面影响：
  - 失败可恢复路径稳定：用户任何时候都能回到失败记录、查看错误并重试
  - 形成可观测的“自动化执行痕迹”，为 Phase B 的 Agent/skills 提供必要的信任基础

- 负面影响 / 代价：
  - 任务记录会增长，需要 UI 筛选/搜索（以及未来的“手动清理/导出日志”能力）
  - 需要一个“重试”端点与（可选）`retryOfTaskId` 字段，保证链路可追溯

- 对现有代码/数据的迁移要求：
  - 若当前任务系统只有 `pending/running/completed/failed`，建议补齐 `canceled`（用于可取消语义）
  - 文档与接口需明确：`retry` 会创建新任务，而不是修改原任务

