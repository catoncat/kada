# ADR 0004：允许删除任何版本；删除当前版本时自动回退到最近版本

## 背景

在本产品里，任何生成类动作（方案生成、图片生成/编辑）都会产生“版本”。版本管理的目标是：

- 用户敢于试错（不覆盖旧版本）
- 用户能随时清理不想要的版本释放空间
- UI/数据永远有一个明确的“当前版本指针”（否则用户会迷路）

其中最容易产生歧义的是：**删除当前版本**应该发生什么？

## 选项

1. 选项 A：禁止删除当前版本（必须先切换再删）
   - 优点：实现简单；指针永不悬空
   - 缺点：与“清理省事”目标冲突；用户会被迫做额外步骤

2. 选项 B：允许删除当前版本，但删除后进入空状态（不自动回退）
   - 优点：实现不复杂
   - 缺点：用户删除后页面突然变空，恢复路径不够顺滑；且与“桌面生产力”预期不符

3. 选项 C：**允许删除任何版本；删除当前版本后自动回退到最近版本**（本 ADR 选择）
   - 优点：最省事；符合自动化优先与可清理目标
   - 缺点：需要定义“最近版本”的确定规则；删除确认弹窗要写清回退行为

## 决策

选择 **选项 C：允许删除任何版本；删除当前版本后自动回退到最近版本**。

### 回退规则（必须可预测）

对同一个“版本集合”定义如下：

- 版本集合 = 同一 `ownerType + ownerId + slot`（图片 artifact），或同一 `projectId`（方案版本）
- 当前版本指针 = `currentArtifactId` / `currentPlanVersionId`（命名按实现）

当用户删除一个版本时：

1. 删除非当前版本：直接删除该版本（记录 + 本地文件），当前指针不变
2. 删除当前版本：
   - 执行删除（记录 + 本地文件）
   - **自动选择回退版本**：按 `createdAt` 降序选择剩余版本中最新的一个作为新的当前版本
   - 若集合中已无任何版本：当前指针设为 `null`，UI 进入该 slot 的空状态（例如显示 `生成第一个版本`）

> 关键要求：回退选择必须是确定性的（建议：`createdAt DESC, id DESC` 作为 tie-break）。

### 删除确认弹窗（必须写清影响）

删除当前版本时，确认文案必须包含：

- 将删除“记录 + 本地文件（不可恢复）”
- 删除后将自动切换到“最近版本”（或“若无则进入空状态”）

## 后果

- 正面影响：
  - 用户可以“随删随用”，不需要先切换版本再清理
  - 自动化程度更高，但仍然可控（有二次确认 + 行为可预测）

- 负面影响 / 代价：
  - 需要在后端实现“删除 + 选出回退版本 + 更新指针”的原子性（避免指针悬空）
  - UI 必须正确处理“删除后瞬时切换版本”与“无版本空态”

- 对现有代码/数据的迁移要求：
  - 需要在数据层有明确“当前指针”（不论是字段、关联表还是计算逻辑）
  - 需要定义一个一致的“版本排序字段”（建议 `createdAt`）

