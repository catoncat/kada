# 重构路线图（建议）

目标：在不牺牲现有“生成→编辑→出图→导出”的核心体验下，让架构、数据与运行方式一致，便于继续迭代功能。

## 北极星原则（重构过程中不变的东西）

1. **输出可解释**：预案必须是结构化的（可展示、可导出、可编辑），而不是一段散文。
2. **成本可控**：图片生成默认手动触发，批量动作必须二次确认。
3. **契约稳定**：`Plan JSON`、`Provider`、`/api/ai/*` 这些边界优先稳定，内部实现可替换。

## 阶段 0：对齐“当前真相源”

- 以 `docs/engineering/contracts.md` 固化当前数据结构与本地存储键
- 明确“现阶段哪些能力必须可用”（最小可用路径：单主题文本生成 + PPT 导出）

## 阶段 1：消除双轨与重复实现（低风险收益）

优先做“删/合并”而不是“改大结构”：

- 统一 prompt/标题构建：避免重复文件（例如多个 buildProjectPrompt/buildProjectTitle 的版本）
- 梳理未使用模块（例如旧版 API client）并决定删除或迁移
- 把 “Provider 来源” 做成单一入口（先约定：前端 localStorage 为准，或 Sidecar DB 为准）

验收：功能不变，代码入口更少，调用链更清晰。

## 阶段 2：持久化策略定稿（关键决策点）

需要做出选择并写 ADR：

- 预案历史：继续 localStorage（简单） vs 迁移到 Sidecar SQLite（可扩展/可搜索/更像桌面应用）
- Provider 配置：前端 localStorage vs Sidecar DB（涉及“密钥存放位置/安全模型”）
- 设置（主题示例等）：是否也统一进 Sidecar settings 表

建议：如果目标是“桌面应用长期使用”，逐步迁移到 Sidecar DB 更合适，但要定义清晰的安全边界与导入/导出机制。

## 阶段 3：Tauri 运行方式闭环（桌面必做）

目前架构在 dev 依赖 Vite proxy（`/api → :3001`）。要让打包后可用，需要明确：

- Sidecar 是否随 Tauri 启动、如何启动、生命周期与端口管理
- 前端 `/api/*` 在 Tauri 产物中如何路由到 Sidecar（改 base、加代理层、或 Tauri 拦截）
- Sidecar 二进制命名/打包方式与 `tauri.conf.json` 的一致性

验收：打包后的桌面应用能完成“生成文本/生成图片/导出 PPT”。

## 阶段 4：体验与质量

- 增加基本的错误分类与可恢复机制（超时、鉴权失败、模型不支持图片等）
- 增加最小测试集：JSON 解析、prompt 构建、导出 PPT 的关键路径
- 性能与成本：批量出图队列、取消、并发控制、缓存策略

