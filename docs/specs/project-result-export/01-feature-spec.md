# 项目结果页与导出（Project Result & Export）

> FEATURE_SLUG: `project-result-export`  
> 范围对齐：`docs/refactor/v2-roadmap.md` Phase 4（P4.1 生成结果页 + P4.2 PPT 导出适配）

## 背景与目标

- 背景：
  - 产品北极星（见 `docs/product/overview.md`）：输入项目主题/资产配置，生成“分镜结构 + 镜头建议 + 生图提示词”，并可按需生成参考图与导出 PPT，用于拍摄前沟通与执行。
  - 目标用户：摄影师/摄影工作室、电商品牌/内容团队（核心诉求是“快速产出可执行预案，并能对外沟通/落地执行”）。
  - 当前实现现状：
    - 已有项目流：项目列表 → 项目详情（配置场景）→ 创建“预案生成任务” → 生成完成后进入结果页（`/project/$id/result`）。
    - 结果页目前只做了基础展示（主题/创意思路/文案/分镜列表），**导出 PPT 仍是占位**，参考图生成也未形成可用闭环（缺少“生成/批量生成/持久化/导出嵌入”）。
- 目标（用户价值）：
  - 用户在结果页能“一眼看懂预案”，并能把结果**快速转成可对外沟通的 PPT**（默认文本版，可选含参考图）。
  - 参考图生成可控（可单张/批量、可取消、可重试），生成结果可在刷新后仍可查看，并可用于导出嵌入。
  - 失败/缺配置时给出明确、可恢复的提示（比如未配置 Provider、模型不支持图片等）。
- 本期核心功能（MVP）：
  - 必须有（3–5 项）：
    - 结果页完善展示（预案概要 + 分镜列表 + visualPrompt 可查看/复制）
    - 参考图生成（单张 + 批量 + 取消 + 重试）与结果回显
    - 参考图持久化（刷新后仍可查看）
    - PPT 导出：文本版 +（可选）含参考图版 + 风格选择
  - 以后再说：
    - visualPrompt 编辑与版本管理
    - 默认自动生成全部参考图、智能挑图、成本优化策略
- 非目标（明确不做）：
  - 不在本期实现：服装/道具/拍摄参数等配置模块的完整交互（这些在路线图后续迭代）。
  - 不做：visualPrompt 的编辑器与版本管理（本期只需“查看/复制/用于出图”；是否支持编辑属于后续增强）。
  - 不做：云端同步、多人协作、复杂项目管理。

## 用户故事 / 使用场景

- 作为摄影师/工作室主理人，我想在“项目结果页”查看完整分镜与参考图，并一键导出 PPT，以便快速与客户对齐拍摄预期并用于现场执行。
- 作为内容团队，我想用同一套项目资产生成稳定风格的参考图，并把“文本 + 图片”一起导出，以便内部评审与跨团队协作。

## 交互与流程

- 入口：
  - 项目详情页：当项目状态为 `generated` 时出现“已生成预案，点击查看”入口进入结果页。
  - 顶部任务队列抽屉：预案生成任务完成后可点“查看结果 →”直达结果页。
- 主流程（分步骤）：
  1. 用户进入结果页，看到：
     - 预案概要：`title / theme / creativeIdea / copywriting`
     - 分镜列表：每个场景 `location / description / shots / lighting`，并可展开查看 `visualPrompt`（至少支持复制）。
  2. 用户按需生成参考图：
     - 单场景：点击“生成参考图/重新生成”，进入进行中状态，成功后在该场景卡片展示生成图。
     - 批量：点击“生成全部参考图”，二次确认（提示可能消耗额度）后开始队列；展示进度（已完成/总数）并提供“取消”。
     - 生成图展示优先级：**已生成参考图** > 场景资产主图（作为参考输入的原图） > 占位。
  3. 用户导出 PPT：
     - 选择 PPT 风格（使用既有 `PPT_STYLES`）。
     - “导出 PPT（文本版）”：始终可用。
     - “导出（含参考图）”：当至少存在 1 张已生成参考图时可用；未生成的场景在 PPT 中留空占位/提示。
  4. 用户需要调整方向时可点击“重新生成”：
     - 创建新的预案生成任务；
     - 生成完成后结果页刷新为新预案；
     - 旧预案下已生成参考图不再保证匹配（见“数据与接口影响/迁移策略”里的处理策略）。
- 异常/边界流程：
  - 项目不存在/网络错误：展示错误提示，并提供返回列表入口。
  - 项目尚未生成预案（`generatedPlan` 为空）：展示空状态，并提供“返回配置”入口。
  - 未配置在线 Provider 或图片模型不可用：
    - 参考图生成按钮仍可见但点击后给出可理解提示，并引导去设置页完成配置（或提示当前 Provider 不支持图片）。
  - 批量生成中途取消：
    - 停止创建后续任务/请求；
    - 已完成的结果保留；
    - 未开始的场景保持未生成状态。
  - 某些场景生成失败：
    - 场景卡片显示失败状态与错误原因；
    - 支持单场景重试，不影响其它场景继续生成/导出。

## 数据与接口影响

- 新增/修改的数据结构（引用 `docs/engineering/contracts.md`）：
  - 需要补齐并稳定 v2 的 `Project.generatedPlan` 结构（当前代码里以 `GeneratedPlan`/`GeneratedScene` 形式隐式存在，但未进入契约文档）。
  - 建议将 v2 结果契约写成（字段名仅示例，以实现为准）：
    - `generatedPlan.title/theme/creativeIdea/copywriting/scenes[]`
    - `generatedPlan.scenes[].location/description/shots/lighting/visualPrompt`
    - `generatedPlan.scenes[].sceneAssetId/sceneAssetImage`（用于图+文生图参考输入与回显）
    - `generatedPlan.scenes[].generatedImagePath?`（持久化后的参考图路径，如 `/uploads/<file>.jpg`，用于刷新后回显与导出）
  - 约束：不建议把 base64 长图直接持久化到 `generatedPlan`（体积大、影响 DB 与网络传输）；优先持久化为文件并仅存路径。
- 新增/修改的 API（引用 `docs/engineering/api.md`）：
  - 本 Feature 目标是“闭环可用”，允许只用现有接口完成闭环，但需要明确调用关系：
    - 生成预案：`POST /api/projects/:id/generate`（已有）
    - 获取项目：`GET /api/projects/:id`（已有）
    - 生成参考图：`POST /api/ai/generate-image`（已有；需支持 referenceImages，用场景资产主图作为输入）
    - 持久化参考图：`POST /api/upload`（已有；将生成图转成文件上传）
    - 写回项目：`PUT /api/projects/:id`（已有；把 `generatedImagePath` 写回 `generatedPlan`）
  - 方案分歧/取舍（建议触发 ADR）：
    - A（推荐）：参考图生成也走任务队列（`/api/tasks` + Worker），便于统一进度/取消/重试；但需要让 `image-generation` 任务支持 `referenceImages/options`，与 `/api/ai/generate-image` 能力对齐。
    - B（备选）：参考图生成直接走 `/api/ai/generate-image` 同步请求，由前端做队列与取消；实现更快但进度/失败可观测性较弱，且不进入任务抽屉。
- 迁移策略（如有历史数据）：
  - 兼容旧项目：若旧 `generatedPlan` 不包含 `lighting` 或没有 `generatedImagePath`，结果页应能正常展示（缺字段则隐藏/展示占位）。
  - “重新生成预案”时的参考图处理策略（二选一，需在实现前确定）：
    - 清空策略（推荐）：重新生成后清空该项目下旧 `generatedImagePath`，避免错配。
    - 保留策略：仅在场景数与关键字段一致时尝试保留（复杂度更高，非必要不做）。

## 验收标准

- [ ] 结果页在四种状态下可用且可理解：加载中 / 项目不存在(或错误) / 未生成预案(空状态) / 已生成预案(正常展示)。
- [ ] 已生成预案时，结果页能展示预案概要与分镜列表（包含 `location/description/shots/lighting`），并可查看与复制 `visualPrompt`。
- [ ] 支持单场景生成参考图：生成中有明显状态；成功后回显生成图；失败时给出错误并允许重试。
- [ ] 支持批量生成参考图：有二次确认、进度展示、可取消；取消后不再继续创建后续生成请求/任务。
- [ ] 参考图持久化：刷新页面/重新打开项目后，已生成参考图仍可回显（通过 `generatedImagePath` 或等价机制）。
- [ ] PPT 导出：
  - [ ] 可选择 PPT 风格（至少支持当前已有的 style 列表）。
  - [ ] “导出 PPT（文本版）”始终可用，导出的 `.pptx` 可打开且内容完整。
  - [ ] “导出（含参考图）”在至少有 1 张参考图时可用；未生成图片的场景在 PPT 中有明确占位提示。
- [ ] 失败场景（至少覆盖以下两类）：
  - [ ] 未配置在线 Provider / 无 API Key：点击生成参考图时提示原因，并给出前往设置的可恢复路径。
  - [ ] 图片生成接口超时/返回错误：场景卡片显示失败状态与错误信息，不影响其它场景继续操作与导出。

## 风险与回滚

- 风险：
  - 参考图文件体积与数量可能导致导出耗时变长/内存压力增大；需要对图片尺寸与并发做约束（例如复用 `/api/upload` 的压缩策略）。
  - 不同 Provider/模型对图+文生图能力差异较大，可能出现“生成成功但质量不可控”的用户预期问题（需要在文案与默认策略上做约束）。
  - 任务表长期堆积（若采用任务队列方案）会带来存储膨胀，需要后续引入清理策略。
- 回滚方案：
  - 可先只保留“文本版 PPT 导出”，将“含参考图”与批量生成作为可开关的增强项；出现稳定性问题时可临时隐藏相关入口，不影响主流程查看结果与文本导出。
