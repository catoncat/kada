# 任务复盘中心：UX Spec（Task Replay Center）

> FEATURE_SLUG: `task-replay-center`  
> 基于：`docs/specs/task-replay-center/01-feature-spec.md`  
> 交互取向：保守可控（默认）  
> 风格偏好：强引导但不打扰（默认）

## 1. Mental Model

用户把“任务复盘中心”理解为一个「可追溯的操作记录台」，而不是仅看进度的队列：

1. 它像“列表 + 详情”的工作台：
   - 左侧（或上层）是任务历史索引，用于快速定位。
   - 右侧（或下层）是任务证据面板，用于确认“当时输入了什么，系统实际执行了什么，结果是什么”。
2. 每条任务都是一次“可复盘快照”：
   - 输入快照（prompt、参考图、owner、参数）
   - 执行快照（effectivePrompt、run、状态流转）
   - 产物快照（图片路径、版本链）
3. 复盘不是终点，恢复才是终点：
   - 用户最终目标是“继续推进任务”：重试、按原参数再生成、跳回来源页面修正。

## 2. Information Architecture（IA）

默认信息层级按“先定位任务，再解释原因，再恢复动作”组织。

1. 一级：任务列表区（默认焦点）
   - 分组：进行中 / 历史
   - 筛选：任务类型、状态、是否含参考图
   - 搜索：任务 ID / 项目名 / 场景槽位
2. 二级：任务详情区（点击列表项后展开）
   - 概览：类型、状态、时间、关联对象、来源入口
   - Prompt：draftPrompt、effectivePrompt、分段上下文
   - 图像参数：referenceImages、owner、editInstruction、parentArtifactId、options
   - 结果：run/artifact、预览图、错误详情、状态时间线
3. 三级：恢复动作区（固定在详情底部）
   - `重试任务`
   - `按原参数再生成`
   - `跳转来源`
   - `复制复盘信息`

默认焦点规则：

1. 首次进入：焦点停留在筛选条与第一条任务。
2. 从外部深链进入：自动定位到目标任务并展开详情。
3. 打开失败任务：优先聚焦“错误与恢复动作”。

### 2.1 已定稿口径（强制）

1. Provider 可用性按任务类型分流：
   - `plan-generation`：存在可用文本能力（在线或本地降级）时允许“按原参数再生成”。
   - `image-generation`：若无可用图片能力（无 Provider / 无 Key / 模型不支持 image），禁止创建重放任务并引导去设置。
2. 重放动作必须幂等：
   - 前端：点击后按钮立即锁定（loading + disabled），防止重复提交。
   - 后端：`POST /api/tasks/:id/replay` 必须接受 `requestId` 并在幂等窗口内去重；重复请求返回同一 `taskId`。
3. 深链失效必须可恢复：
   - 访问已删除任务时，不得只给裸 404 页面。
   - 必须提供 3 个恢复动作：`返回任务列表`、`查看同来源最近任务`、`跳转来源页面`。

## 3. Affordance

关键可发现性要求：

1. 任务卡片显式展示“可复盘”入口，而不是只显示状态文字。
2. Prompt 区域明确标签：
   - `Draft Prompt（用户输入）`
   - `Effective Prompt（服务端实际执行）`
3. 图像参数显式区分“文本输入”和“图片输入”：
   - 参考图以缩略图 + 原始路径双形态展示。
4. 恢复动作用主次按钮区分：
   - 主按钮：`重试`（失败任务）或 `按原参数再生成`（已完成任务）
   - 次按钮：`复制信息`、`跳转来源`
5. 高级字段（promptContext JSON、时间线细节）默认折叠，避免信息压垮首次用户。

## 4. System Feedback（含下一步与恢复路径）

### 4.1 Empty States（至少 3 个）

1. 首次进入任务中心（无任何任务）
   - 提示：`还没有任务记录。先生成一次预案或参考图。`
   - 下一步：`去项目页`（主按钮）
   - 恢复路径：跳转后完成一次生成，再返回自动刷新列表。

2. 当前筛选结果为空（有历史但当前筛选无结果）
   - 提示：`没有匹配的任务，试试放宽筛选条件。`
   - 下一步：`清空筛选`
   - 恢复路径：一键重置筛选并回到最近任务。

3. Provider 不可用（按任务类型分流）
   - 提示：
     - `plan-generation`：`将使用文本降级能力继续执行。`
     - `image-generation`：`当前 Provider 不可用，无法执行图片重放。`
   - 下一步：
     - `plan-generation`：`继续重放`
     - `image-generation`：`去设置 Provider`
   - 恢复路径：按对应分流策略继续或返回配置后再执行。

### 4.2 Loading States（至少 3 个）

1. 提交重试/再生成
   - 反馈：按钮进入 loading 且不可重复点击，详情顶部显示 `已创建新任务，等待执行` 或 `已命中去重，复用现有任务`。
   - 下一步：`查看新任务`
   - 恢复路径：跳转新任务详情或留在当前页轮询更新。

2. 拉模型列表/测试连接（设置页）
   - 反馈：`拉取模型`/`测试连接`按钮 loading，列表区域显示 skeleton。
   - 下一步：等待返回；超时后显示 `重试` 与 `检查网络`。
   - 恢复路径：保留已填 Provider 配置，不清空表单内容。

3. 批量生图任务的详情刷新（部分完成）
   - 反馈：状态时间线显示 `x / y 已完成`，失败项即时标记。
   - 下一步：`仅重试失败项`
   - 恢复路径：失败项独立重试，不影响成功项。

### 4.3 Error States（至少 6 个）

1. 无 Key / 未配置 Provider
   - 文案：
     - `plan-generation`：`当前将使用文本降级能力执行重放。`
     - `image-generation`：`未配置可用图片能力，当前任务无法重放。`
   - 下一步：
     - `plan-generation`：`继续重放` 或 `去设置（可选）`
     - `image-generation`：`去设置`
   - 恢复路径：
     - `plan-generation`：降级执行并创建新任务记录。
     - `image-generation`：配置完成后回到原任务再执行。

2. 401/403（鉴权失败）
   - 文案：`鉴权失败：API Key 无效或权限不足。`
   - 下一步：`编辑 Provider`、`重新测试连接`
   - 恢复路径：测试成功后重试原任务。

3. 超时/网络不可用
   - 文案：`网络异常或请求超时，任务详情暂时不可用。`
   - 下一步：`重试加载`
   - 恢复路径：保留当前选中任务，不强制回到列表顶部。

4. 模型不支持（text/image 能力不匹配）
   - 文案：`当前模型不支持该任务类型（图片/文本能力不匹配）。`
   - 下一步：`切换模型`
   - 恢复路径：切换后可直接基于原参数新建任务。

5. LLM 返回 JSON 不合法（预案生成解析失败）
   - 文案：`模型返回格式异常，未能解析为有效预案。`
   - 下一步：`查看原始输出`、`重新生成`
   - 恢复路径：复制原始输出给团队排查，或更换模型后重跑。

6. 图片生成失败（单任务/部分任务）
   - 文案：`图片生成失败：{具体错误}`。
   - 下一步：`重试当前任务` / `仅重试失败项`
   - 恢复路径：已成功图片保留，失败项进入新的任务记录。

7. 历史字段缺失（旧数据）
   - 文案：`该任务来自旧版本，部分参数未记录。`
   - 下一步：`查看可用字段`、`按当前参数重新生成`
   - 恢复路径：通过新任务补齐完整可追溯链路。

## 5. Component Detail（与仓库现状对齐）

### 5.1 Sidebar（历史切换/删除/空态）

1. 历史切换
   - 列表项点击即切换详情，不触发页面跳转。
   - 保留当前筛选与滚动位置，便于连续比对多条任务。
2. 删除
   - 非运行中任务允许删除，删除前二次确认。
   - 删除后焦点回到相邻任务，避免“空焦点”。
3. 空态
   - 无历史：展示主 CTA（去生成）。
   - 筛选为空：展示清空筛选 CTA。

### 5.2 结果页（单预案 vs 项目预案）

1. 单预案结果页（历史模式兼容）
   - 从任务详情跳转后应落到对应结果上下文。
   - 若缺场景索引，仅定位到结果页顶部并提示“已打开关联任务”。
   - 若任务已删除导致深链失效，展示可恢复页并提供“返回任务列表/查看最近任务/跳转来源”。
2. 项目预案结果页（当前主流程）
   - `planScene` 任务跳转时带 `scene` 与 `openEdit` 参数，自动定位并打开对应场景编辑区域。
   - 在场景卡片增加“查看最近任务”入口，形成“结果 ↔ 任务复盘”双向链路。

### 5.3 设置（Provider 管理、主题示例编辑器）

1. Provider 管理
   - 错误态（401/403/模型不支持）必须可从任务详情一键跳转到对应设置区。
   - 设置页保存后返回来源任务，不丢失复盘上下文。
2. 主题示例编辑器
   - 与任务复盘中心保持一致文案原则：错误可理解、下一步明确。
   - 当任务失败原因与提示词模板相关时，提供“前往提示词编排设置”入口。

## 6. Copy & Microcopy

文案原则：

1. 每条错误必须包含三件事：发生了什么、为什么、现在怎么做。
2. 避免“未知错误”；若无法分类，至少提供 `复制错误详情` 与 `重试`。
3. 按动作风险写确认文案：
   - 删除：强调不可恢复。
   - 重跑：强调会创建新任务并可能消耗额度。

可直接使用的文案示例：

1. 按原参数再生成确认：`将基于当前任务参数创建新任务，原任务不会被覆盖。继续吗？`
2. 删除任务确认：`删除后将无法在任务中心查看该记录。继续删除吗？`
3. 旧数据提示：`该记录生成于旧版本，部分字段未记录。建议重跑一次以获得完整复盘信息。`
4. 复制成功反馈：`已复制复盘信息，可用于排查或复现。`

## 7. A11y 最低要求

1. 焦点管理
   - 打开任务详情抽屉后焦点进入标题。
   - 关闭后焦点返回触发的任务项。
2. 键盘交互
   - `Esc` 关闭详情抽屉/弹窗。
   - `Enter` 触发当前焦点主操作（如重试）。
3. 语义与可读性
   - 任务状态图标必须有文本标签与 `aria-label`。
   - 参考图缩略图提供可读替代文本（至少包含任务 ID 或场景信息）。
   - 复制按钮、重试按钮、跳转按钮均需明确 `aria-label`。
