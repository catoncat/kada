# 任务复盘中心（Task Replay Center）

> FEATURE_SLUG: `task-replay-center`  
> 范围：任务模块可完整复盘每次生成（文本/图片参数/产物/错误/恢复路径）

## 背景与目标

- App Overview（一句话）：
  - 为拍摄预案应用提供“任务级可追溯工作台”，让每次 AI 生成都能被查看、解释与复现。
- 背景：
  - 当前任务队列可看到基础状态与简要内容，但对“这次为什么生成成这样”缺少完整复盘视图。
  - 对图+文生图场景，用户需要看到完整提示词（draft/effective）与参考图参数，才能稳定迭代风格并复现结果。
  - 目标用户：
    - 摄影师与修图师：需要追溯每次出图输入与上下文，快速复刻或微调。
    - 项目负责人：需要排查失败原因并指导团队重试，不依赖工程同学查日志。
- 目标（用户价值）：
  - 用户可以在任务模块查看每个任务的完整复盘信息（输入、上下文、执行结果、失败原因、下一步操作）。
  - 用户可以从任一任务快速恢复工作流（重试、跳转来源页面、按原参数再生成）。
  - 任务历史可用于对外沟通与内部复盘，减少“靠记忆还原参数”的沟通成本。
- 本期核心功能（MVP）：
  - 必须有：
    - 任务类型清晰可辨（`plan-generation` / `image-generation`）并支持筛选。
    - 每个任务可查看完整输入参数（含完整 prompt 与图片参数）。
    - 每个任务可查看执行结果（产物、状态变化、错误信息）与恢复路径。
    - 任务详情支持复制关键信息（prompt、错误、参数快照）。
  - 以后再说：
    - 任务间 diff 对比（同场景多次生成差异高亮）。
    - 自动根因归类与修复建议（AI 辅助诊断）。
- 非目标（明确不做）：
  - 不在本期实现“自动修改提示词并自动重跑”。
  - 不在本期实现多用户协作审阅/评论任务。
  - 不改变现有生成算法与模型选择策略，仅提升可观测性与复盘交互。

## 用户故事 / 使用场景

- 作为摄影师，我想查看某张参考图对应的完整 effectivePrompt 和参考图输入，这样我可以复刻同风格图片。
- 作为修图师，我想知道一次图生图失败时具体带了哪些参数和参考图，以便我快速重试而不是重新配置。
- 作为项目负责人，我想从任务历史直接跳回对应项目/场景，并带着上下文继续处理问题。

## 交互与流程

- 入口：
  - 全局导航栏任务入口（现有任务抽屉入口）进入任务中心。
  - 项目结果页/场景卡片可跳转到对应任务详情（按任务 ID 或场景 owner 定位）。
- 主流程（分步骤）：
  1. 用户打开任务中心，默认看到“进行中 + 历史”列表，按时间倒序。
  2. 用户通过筛选（任务类型/状态/是否含参考图）快速定位目标任务。
  3. 点击任务后进入任务详情（右侧详情面板或独立详情页），查看：
     - 基本信息：任务类型、状态、创建时间、关联项目/场景。
     - 输入快照：draftPrompt、effectivePrompt（如有）、owner、referenceImages、editInstruction、parentArtifactId、options。
     - 输出快照：artifact/run 信息、文件路径、尺寸、状态流转、错误信息。
  4. 用户执行恢复动作：
     - 重试失败任务；
     - 按原参数再生成（创建新任务）；
     - 跳转到来源页面继续编辑（例如项目结果页对应场景）。
  5. 用户在详情中复制 prompt/错误/参数给团队沟通或沉淀文档。
- 异常/边界流程：
  - 任务不存在/已删除：提示“任务不存在或已移除”，提供返回任务列表入口。
  - 历史为空：显示空状态并提示“先去生成一次预案或参考图”。
  - 任务信息不完整（历史数据缺字段）：缺失字段以“未记录”展示，不阻断其它字段查看。
  - 仅部分场景失败：支持按失败项重试，不影响已完成项保留。

## 数据与接口影响

- 新增/修改的数据结构（引用 `docs/engineering/contracts.md`）：
  - `TaskDetailView`（建议新增契约）：
    - `task`：任务基础字段（id/type/status/input/output/error/relatedId/relatedMeta/timestamps）。
    - `run`：关联 generation run（kind/status/effectivePrompt/promptContext/error）。
    - `artifacts[]`：关联产物（filePath/mimeType/owner/referenceImages/editInstruction/parentArtifactId）。
    - `timeline[]`：状态变更时间线（pending/running/completed/failed）。
  - 约束：
    - 输入与上下文采用“快照语义”，任务完成后不可被后续编辑覆盖。
    - 历史缺字段时保持兼容解析（可空字段 + 显式未记录）。
- 新增/修改的 API（引用 `docs/engineering/api.md`）：
  - 新增建议：`GET /api/tasks/:id/detail`
    - 返回任务 + 关联 run + artifacts + 可直接渲染的复盘字段。
  - 保持兼容：现有 `GET /api/tasks` / `GET /api/tasks/:id` 继续可用。
  - 可选增强：`POST /api/tasks/:id/replay`（按原参数复制创建新任务）。
  - 需要同步更新：
    - `docs/engineering/contracts.md`（任务详情返回结构）
    - `docs/engineering/api.md`（任务详情/重放接口）
  - 方案分歧/取舍（建议触发 ADR）：
    - A：详情聚合在后端（前端请求一次即可渲染，推荐）。
    - B：前端并发请求任务/run/artifact 再拼装（实现快但一致性与维护成本较高）。
- 迁移策略（如有历史数据）：
  - 历史任务若缺少 run/artifact 关联，不做阻断；详情页展示“该记录来自旧版本，部分字段不可用”。
  - 新任务创建后必须保证可追溯链路完整（taskId ↔ runId ↔ artifactId）。

## 验收标准

- [ ] 任务中心可展示并筛选两类任务：`plan-generation`、`image-generation`。
- [ ] 任一 `image-generation` 任务可在详情中查看完整 prompt 与图片参数（至少含 draft/effective、referenceImages、owner）。
- [ ] 任一失败任务详情可显示可操作恢复路径（重试、跳转来源、复制错误信息）。
- [ ] 任务详情可复制关键复盘信息（prompt、参数快照、错误）且复制后可用于复现同类请求。
- [ ] 旧历史任务（字段不完整）可正常打开详情，并明确标记缺失字段，不出现页面崩溃。
- [ ] 成功标准（可验证）：
  - [ ] 团队可在不查服务端日志的前提下，通过任务详情定位一次失败的主要原因。
  - [ ] 团队可基于任务详情完成“按原参数再生成”并产出新任务记录。
  - [ ] 从任务详情跳转到对应来源页面后，能定位到正确项目/场景上下文。
- [ ] 失败场景（至少 2 条）：
  - [ ] 网络/超时导致任务详情加载失败时，有可理解提示与重试入口。
  - [ ] Provider 未配置或鉴权失败导致任务失败时，详情中有可执行下一步（去设置/重试）。

## 风险与回滚

- 风险：
  - 详情聚合字段增多，若缺乏分页/懒加载，可能导致任务中心首屏加载变慢。
  - 历史数据一致性不足（尤其早期任务），可能出现“有 task 无 run/artifact”。
  - 参数透传展示过多会增加认知负担，需要默认折叠高级字段。
- 回滚方案：
  - 若详情聚合接口不稳定，先降级为“保留列表 + 基础详情”，隐藏高级复盘区。
  - 保留现有任务抽屉行为作为兜底入口，新增复盘能力可按开关逐步放量。
