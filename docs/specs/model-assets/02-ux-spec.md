# 模特资产模块：UX Spec（Model Assets）

> FEATURE_SLUG: `model-assets`
> 交互取向：保守可控（模特配置为可选步骤，不阻塞主流程）
> 风格偏好：强引导但不打扰（空状态有明确 CTA，已配置时低调展示状态）
> 技术栈：Base UI + Tailwind，TanStack Router/Query
> 前置文档：`docs/specs/model-assets/01-feature-spec.md`

## 1) Mental Model（心智模型）

用户把模特资产模块理解为两个层级的操作：

1. **模特库（全局资产）**：像"通讯录"一样管理工作室常用的人物形象——每个模特有名字、照片、外观描述。它属于资产体系的一部分，与场景资产并列。
2. **项目模特配置（项目内映射）**：像"角色选角"一样把项目中的客户人物与模特库中的形象关联起来。这是一个**可选的增强步骤**——不配就用旧的方式生图，配了就自动注入一致性信息。

关键认知：
- 模特 ≠ 客户人物。客户人物是"谁要拍"（role/gender/age），模特是"长什么样"（外观描述 + 参考照片）。
- 参考照片是一致性的核心锚点。用户需要理解"上传的照片会被传给 AI 作为参考"。
- 外观提示词是文字层面的锚点。它会出现在 effectivePrompt 中，用户可在 Image Studio Lite 中看到和编辑。

## 2) Information Architecture（信息架构/默认焦点）

### 全局导航中的位置

模特资产嵌入现有 `资产` 顶层入口：

```
资产（Assets）
├── 场景（Scenes）     ← 已有
├── 模特（Models）     ← 新增 Tab
├── 道具（Props）      ← 已有（未来）
└── 服装（Outfits）    ← 已有（未来）
```

### 项目工作流中的位置

项目详情工作区的步骤顺序：

```
项目详情（ProjectWorkspace）
├── 基本信息（标题/客户信息）   ← 已有
├── 选择场景                  ← 已有
├── 模特配置                  ← 新增（可选步骤）
├── 生成方案                  ← 已有
└── 查看结果                  ← 已有
```

### 默认焦点规则

1. 进入"资产 > 模特"：若模特库为空 → 焦点在空状态 CTA；否则焦点在搜索框
2. 进入"项目 > 模特配置"：若客户信息未填 → 焦点在引导提示；否则焦点在人物列表第一项
3. 自动匹配完成后：焦点在推荐结果确认区

### 信息优先级（模特卡片）

从高到低：主参考照片 > 名称 > 性别/年龄标签 > 外观提示词摘要 > 标签

## 3) Affordance（可发现性/关键交互显性提示）

### 资产页模特 Tab

| 交互区 | 显性提示方式 |
|---|---|
| 新建模特 | 页面右上角常驻 `+ 新建模特` 按钮（主色） |
| 编辑/删除 | 卡片 hover 出现操作按钮（与 SceneCard 一致） |
| 外观提示词 | 卡片中截断展示首行，点击卡片进入编辑看全文 |
| 参考照片数量 | 卡片右下角 badge：`3 张参考图` |
| 全局 vs 项目专属 | 项目专属模特卡片左上角显示项目名称标签 |

### 项目模特配置页

| 交互区 | 显性提示方式 |
|---|---|
| 自动匹配 | 页面顶部操作栏 `自动匹配` 按钮（次级按钮，仅在有人物且有模特时可用） |
| 手动指定 | 每个人物行右侧 `选择模特` 下拉/弹出选择器 |
| 快速创建 | 人物行或模特选择器底部 `+ 新建模特` 链接 |
| 配置状态 | 步骤标题旁 badge：`已配置 2/3`（绿色=全部配置，灰色=部分/未配置） |
| 可跳过 | 步骤标题下方灰色说明文字：`模特配置为可选步骤，跳过后生成的预览图不含人物参考` |

### 生成时的模特信息反馈

| 场景 | 显性提示 |
|---|---|
| 已配置模特时生成 | Image Studio Lite 的 effectivePrompt 中可见 `## 人物外观描述` 段落 |
| 未配置模特时生成 | 无额外提示（向后兼容，静默跳过） |
| 生成结果页 | 场景卡片标注"已使用 N 张模特参考图"（promptContext 中读取） |

## 4) System Feedback（系统反馈：Empty/Loading/Error + 恢复路径）

### 4.1 Empty States

#### E1. 模特库为空（资产 > 模特页，首次进入）

```
┌─────────────────────────────────────────┐
│                                         │
│         [人物轮廓图标]                    │
│                                         │
│        还没有模特资产                     │
│                                         │
│  创建模特资产并上传参考照片，             │
│  用于生成预览图时保持人物一致性           │
│                                         │
│       [ + 新建模特 ]（主色按钮）          │
│                                         │
└─────────────────────────────────────────┘
```

- **恢复路径**：点击 CTA 打开创建表单弹窗，创建完成后列表自动刷新并展示新卡片

#### E2. 项目模特配置页：客户信息未填写

```
┌─────────────────────────────────────────┐
│                                         │
│        请先填写客户信息                   │
│                                         │
│  模特配置需要先添加拍摄人物（客户信息），  │
│  才能为每个人物指定对应的模特形象          │
│                                         │
│     [ 去填写客户信息 ]（主色按钮）        │
│                                         │
└─────────────────────────────────────────┘
```

- **恢复路径**：点击 CTA 跳转到项目基本信息编辑区，聚焦到客户信息表单；填写完成后自动回到模特配置页

#### E3. 项目模特配置页：有人物但模特库为空

```
┌─────────────────────────────────────────┐
│  宝宝（男，3岁）      [ 选择模特 ▾ ]     │
│  妈妈（女，30岁）     [ 选择模特 ▾ ]     │
│─────────────────────────────────────────│
│                                         │
│  暂无可用模特，请先创建模特资产           │
│                                         │
│  [ + 新建模特 ]     [ 去模特库 ]         │
│                                         │
└─────────────────────────────────────────┘
```

- **恢复路径**：
  - `新建模特`：在当前页打开创建表单弹窗，`projectId` 自动设为当前项目
  - `去模特库`：跳转到资产 > 模特页面

#### E4. 项目模特配置页：有人物且有模特，但均未配置映射

- 人物列表正常展示，每个人物行右侧显示 `选择模特` 下拉（未选状态）
- 顶部操作栏 `自动匹配` 按钮高亮，提示"点击自动匹配推荐模特"
- 步骤标题旁 badge 显示 `未配置`（灰色）

### 4.2 Loading States

#### L1. 模特列表加载中（资产 > 模特页）

- **反馈**：页面中央 Spinner（与场景页 `assets.scenes.tsx` 一致的 `Loader2` 图标）
- **恢复路径**：加载失败时展示 Error State（见 ER1）

#### L2. 自动匹配计算中

- **反馈**：
  - `自动匹配` 按钮进入 loading 状态（Spinner + "匹配中..."）
  - 按钮 disabled，防止重复点击
- **可恢复**：
  - 超时（>5s）：自动停止，展示"匹配超时，请重试"
  - 失败：保留人物列表现状，不覆盖已有映射

#### L3. 创建/更新模特中（表单提交）

- **反馈**：
  - 提交按钮进入 loading 状态
  - 表单内容不可编辑（防止提交过程中修改导致不一致）
- **可恢复**：
  - 失败时保留表单内容，展示错误提示，可修改后重试

#### L4. 图片上传中（模特参考照片上传）

- **反馈**：
  - 上传区域显示进度条或 Spinner
  - 上传完成后自动更新预览
- **可恢复**：
  - 上传失败时显示"上传失败：<原因>"，保留原有照片，可重试

### 4.3 Error States

#### ER1. 模特列表加载失败

- **文案**：`加载失败：<具体原因>`
- **下一步**：提供 `重试` 按钮
- **展示方式**：Alert 组件（与 `assets.scenes.tsx` 的 error 状态一致）

#### ER2. 模特创建/更新失败

- **文案**：`保存失败：<具体原因>`（如"名称不能为空"、"网络错误"）
- **下一步**：保留表单内容，用户修改后可重新提交
- **展示方式**：表单顶部 inline Alert

#### ER3. 模特删除失败

- **文案**：`删除失败：<具体原因>`
- **下一步**：`重试` / `取消`
- **展示方式**：toast 提示

#### ER4. 自动匹配无结果

- **文案**：`未找到匹配的模特：模特库中没有与当前人物性别/年龄匹配的资产`
- **下一步**：`新建模特`（在当前页创建）/ `手动选择`（忽略匹配条件直接从列表选）
- **展示方式**：操作栏下方 inline 提示

#### ER5. 图片上传失败（磁盘满/无权限）

- **文案**：`上传失败：磁盘空间不足或无写入权限`
- **下一步**：`更换存储位置`（跳转设置）/ `重试`
- **展示方式**：上传区域 inline 错误提示

#### ER6. 模特被删除后项目映射悬空

- 场景：用户在项目 A 中映射了模特 X，之后在资产页删除了模特 X
- **处理**：
  - 项目模特配置页检测到映射指向不存在的模特时，该人物行显示：`⚠ 已删除的模特` + `重新选择` 按钮
  - 生成预览图时静默跳过已删除模特的信息注入（不中断生成）
  - `promptContext` 中记录 `warnings: ["模特 X 已被删除，已跳过注入"]`

#### ER7. 参考图文件丢失

- 场景：模特的 `primaryImage` 或 `referenceImages` 中的文件路径指向不存在的文件
- **处理**：
  - 模特卡片/详情：照片区域显示占位图 + `图片不可用` 标签
  - 生成预览图时：`buildGeminiReferenceParts` 已有容错逻辑（跳过不存在的文件），不中断生成
  - 不主动报错弹窗，避免干扰正常流程

## 5) Component Detail（核心组件交互细节）

### 5.1 ModelAssetCard（模特卡片）

与 `SceneCard` 保持一致的交互模式：

```
┌──────────────────────────────┐
│  ┌────────────┐              │
│  │            │  小明         │
│  │  主参考照   │  男 · 3-5岁  │
│  │            │              │
│  └────────────┘  圆脸，短发…  │
│                              │
│  [儿童] [男孩] [活泼]  3张参考 │
│                   [编辑][删除] │
└──────────────────────────────┘
```

- 点击卡片 → 打开编辑表单弹窗
- hover 右下角出现 `编辑`/`删除` 按钮
- 项目专属模特：左上角显示 `项目：xxx` 标签（浅色背景）
- 无主参考照片时：显示人物轮廓占位图
- 外观提示词：截断显示首行（max 40 字），完整内容在编辑弹窗中查看

### 5.2 ModelAssetForm（模特表单弹窗）

基于 Dialog + 表单，与 `SceneForm` 保持一致的弹窗模式：

```
┌─ 新建模特 ───────────────────┐
│                              │
│  名称 *    [________________]│
│  性别      [男 ▾]            │
│  年龄范围  [3] 岁 ~ [5] 岁   │
│  描述      [________________]│
│                              │
│  ── 参考照片 ────────────────│
│  主参考照   [+ 上传]         │
│  辅助参考   [+ 上传] (最多5张)│
│                              │
│  ── 外观提示词 ──────────────│
│  [多行文本框，中文外观描述]   │
│  hint: "描述人物的外貌特征，  │
│  如肤色、发型、体型、五官等， │
│  将注入到出图提示词中"        │
│                              │
│  标签      [+ 添加标签]      │
│                              │
│      [取消]     [保存]       │
└──────────────────────────────┘
```

字段说明：

| 字段 | 必填 | 验证规则 |
|---|---|---|
| 名称 | 是 | 非空，最长 50 字符 |
| 性别 | 否 | 下拉：男/女/其他 |
| 年龄范围 | 否 | 两个数字输入框，min ≤ max |
| 描述 | 否 | 自由文本 |
| 主参考照 | 否 | 图片文件（jpg/png/webp），单张 |
| 辅助参考 | 否 | 图片文件，最多 5 张 |
| 外观提示词 | 否 | 自由文本（中文），建议 20-200 字 |
| 标签 | 否 | 字符串数组，每个最长 20 字符 |

### 5.3 PersonModelMapper（项目模特配置）

项目内的人物-模特映射组件：

```
┌─ 模特配置（可选） ── 已配置 1/2 ──────────┐
│                                           │
│  [自动匹配]                     [新建模特] │
│                                           │
│  ┌───────────────────────────────────────┐│
│  │ 宝宝（男，3岁）                       ││
│  │ → 模特：小明（圆脸，短发…）  [更换][×] ││
│  │   [缩略图]                            ││
│  ├───────────────────────────────────────┤│
│  │ 妈妈（女，30岁）                      ││
│  │ → [ 选择模特 ▾ ]                      ││
│  └───────────────────────────────────────┘│
│                                           │
│  ℹ 模特配置为可选步骤，跳过后生成的       │
│    预览图不含人物参考                      │
│                                           │
└───────────────────────────────────────────┘
```

#### 交互细节

- **选择模特**：点击 `选择模特` 打开 Popover 或下拉：
  - 按性别/年龄预筛选（匹配当前人物）
  - 展示模特缩略图 + 名称 + 年龄范围
  - 底部 `+ 新建模特`（打开 ModelAssetForm，`projectId` 预填当前项目）
- **更换**：点击 `更换` 重新打开选择器
- **移除映射**：点击 `×` 移除当前人物的模特映射（不删除模特资产，只清除映射关系）
- **自动匹配**：点击后调用 API，返回推荐结果后展示确认 UI：

```
┌─ 自动匹配推荐 ────────────────────────────┐
│                                           │
│  宝宝（男，3岁）                          │
│  → 推荐：小明（95分）/ 小刚（80分）       │
│    [选择 小明]  [选择 小刚]  [跳过]       │
│                                           │
│  妈妈（女，30岁）                         │
│  → 推荐：妈妈A（90分）                   │
│    [选择 妈妈A]  [跳过]                   │
│                                           │
│           [全部应用推荐]  [取消]           │
└───────────────────────────────────────────┘
```

- `全部应用推荐`：为每个人物选择排名第一的推荐模特
- 每行可单独选择或跳过
- 确认后写入 `projects.selected_models`

### 5.4 ProjectWorkspace 集成

在项目工作区（右侧面板）中新增"模特配置"区块：

- **位置**：在"客户信息"区块之后
- **折叠行为**：默认展开（若有人物），可折叠
- **状态标识**：
  - 未配置（无人物）：灰色标题 + `需要先填写客户信息`
  - 部分配置：标题旁 `已配置 1/3`（灰色 badge）
  - 全部配置：标题旁 `已配置 3/3`（绿色 badge）
  - 不阻塞：下方"生成方案"按钮始终可用，不因模特未配置而 disabled

### 5.5 资产页 Tab 切换

在现有资产页 `/assets` 路由下新增模特 Tab：

- Tab 列表：`场景` | `模特`（后续扩展道具/服装）
- 与 `assets.scenes` 路由结构对齐：`assets.models`
- Tab 切换不重新加载，通过 TanStack Router 的嵌套路由实现

## 6) Copy & Microcopy（文案原则与示例）

### 原则

- 模特相关文案使用"模特"而非"模型"（避免与 AI 模型混淆）
- 外观提示词区域给出具体示例引导，降低用户理解成本
- 可选步骤明确标注"可选"/"跳过后的影响"
- 删除操作必须二次确认

### 文案清单

| 场景 | 文案 |
|---|---|
| 模特库空状态标题 | `还没有模特资产` |
| 模特库空状态说明 | `创建模特资产并上传参考照片，用于生成预览图时保持人物一致性` |
| 外观提示词 placeholder | `描述人物的外貌特征，如肤色、发型、体型、五官等` |
| 外观提示词 hint | `此描述将注入到出图提示词中，帮助 AI 保持人物外观一致` |
| 参考照片 hint | `上传的照片将作为参考图传给 AI，是保持人物一致性的关键` |
| 项目模特配置标题 | `模特配置（可选）` |
| 可选步骤说明 | `模特配置为可选步骤，跳过后生成的预览图不含人物参考` |
| 未填客户信息引导 | `请先填写客户信息，添加拍摄人物后即可配置模特` |
| 自动匹配按钮 | `自动匹配` |
| 自动匹配说明 | `根据人物的性别和年龄，从模特库中自动推荐匹配的模特` |
| 自动匹配无结果 | `未找到匹配的模特：模特库中没有与当前人物性别/年龄匹配的资产` |
| 删除模特确认 | `确定要删除模特「{name}」吗？此操作无法撤销。已引用该模特的项目映射将失效。` |
| 映射悬空警告 | `⚠ 模特已被删除，请重新选择` |
| 删除映射确认 | 不需要二次确认（只是移除映射关系，不删除模特资产） |
| 保存成功 toast | `模特已保存` / `模特已更新` |
| 删除成功 toast | `模特已删除` |

## 7) A11y 最低要求

### 焦点管理

- 模特表单弹窗：打开后 focus trap，关闭后焦点回到触发按钮（`新建模特` 或卡片编辑按钮）
- 模特选择器 Popover：打开后焦点在搜索框（若有）或第一个模特选项
- 自动匹配推荐弹窗：打开后焦点在第一个推荐行

### 键盘操作

- `Esc`：关闭模特表单弹窗 / 模特选择器 Popover / 自动匹配推荐弹窗
- `Enter`：在表单中触发保存（主 CTA）
- `Tab`：表单字段间顺序导航
- 模特选择器中：`↑↓` 在选项间移动，`Enter` 选择

### aria 标签

- 模特卡片操作按钮：`aria-label="编辑模特 {name}"` / `aria-label="删除模特 {name}"`
- 参考照片上传区：`aria-label="上传主参考照片"` / `aria-label="上传辅助参考照片"`
- 配置状态 badge：`aria-label="模特配置状态：已配置 {n} / {total}"`
- 映射悬空警告：`role="alert"`
