# 桌面端 MVP 基础：资产管理 + AI 创意方案（Desktop MVP Foundation）

> FEATURE_SLUG: `desktop-mvp-foundation`  
> 产品形态：桌面应用（Tauri），本地优先 / 开箱即用

## 背景与目标

- 背景：
  - App Overview（一句话）：**给摄影工作室提供创意与创作资源管理的 AI 助理**——把场景/道具/服装/方案沉淀为可复用资产，并基于这些资产用 AI 快速产出新的创意方案。
  - Target Audience：摄影工作室
    - 痛点：创意与过往产出（图/文字/方案/提示词）难以结构化沉淀，复用效率低；“每次从 0 开始”导致成本高、风格不稳定。
    - 机会：用“资产库 + 项目流程 + AI 生成/调整”把创意生产标准化，并让资源可持续积累。
  - 关键约束：桌面端强调隐私与离线可用；资源（图片/素材）体量大，更适合本地存储管理。
- 目标（用户价值）：
  - 资产化：用户能把常用场景/道具/服装/提示词沉淀为资产库，并能检索与复用。
  - 方案生产：用户通过“项目流程（固定步骤 UI）”从资产快速拼接上下文，一键生成可执行的创意方案（分镜/镜头建议/风格建议/生图提示词等），并且**生成时即可产出预览图**（用于快速对齐与筛选方向）。
  - AI 贯穿：AI 能穿插在各流程里（不仅是“生成方案”），包括：
    - 资产侧：基于用户上传图片生成描述/标签/要点，并提供通用的 AI 图片编辑能力
    - 流程侧：在每个步骤提供建议与“下一步”引导
    - 对话侧（Phase B）：全局 AI Chat 作为 agent，通过调用我们自己的后端 API 来**直接管理/执行步骤**（类似 Claude Code 的 skills）
  - AI 原生（关键设计原则）：同一套“能力层 API”同时服务于人类 UI 与 AI Agent
    - UI 与 AI 都是客户端：UI 负责交互呈现；AI 负责理解意图、规划与调用 API 执行动作
    - 以 API 调用为主而非 UI 自动化：保证可审计、可控、可回滚，并与版本管理/任务队列统一
  - Prompt 透明度与可编辑性（关键交互原则）：
    - 只要 UI 里涉及“文生图 / 文+图生图”，系统最终用于出图的提示词（effective prompt）必须在前端组件中可见、可编辑、可复制、可复用
    - “重新生成 / 重新编辑”本质是：基于上一版本的 prompt 上下文产生新版本，并进入版本管理（不覆盖旧版本）
- 本期交付切片（建议明确 Phase，避免范围爆炸）：
  - Phase A（MVP，先做 / 必须有）：
    - 资产管理（场景/道具/服装/提示词预设）：CRUD + 标签/搜索 + 图片管理
      - AI 辅助：图片 → 描述/标签草稿（用户确认后写入）
      - AI 图片生成/编辑组件（Image Studio，Lite）：在资产/方案等所有“需要出图”的流程 UI 内复用
        - 默认由系统根据上下文拼接提示词，并在组件中展示 effective prompt（可编辑/复制/复用）
        - 提供基础能力：生成 / 重新生成 / 重新编辑（基于上一版本）/ 版本切换 / 设为主图 / 删除版本
    - 项目流程（固定步骤 UI）：选资产 → 生成方案 → 查看/保存
    - 创意方案生成（含预览图）：生成结构化方案，并自动生成预览图（可逐张/批量、可取消）
    - 版本管理与清理：所有“生成类动作”可回溯（方案版本、资产图片版本等），用户可清理历史版本与文件
  - Phase B（下一里程碑，后做 / 需要预留架构）：
    - 全局 AI Chat（Agent + Skills）：自然语言 → 计划/拟执行动作 → 用户确认 → 调用后端 API 执行并回写 UI（更强自动化）
    - Chat 内更强的“批量/多步”图片操作（Pro）：AI 通过 skills 调用同一套图片生成/编辑 API，结果仍落到版本系统；必要时打开 Image Studio 继续微调
  - 以后再说：
    - 云同步
    - 多人协作 / 团队空间（Team）
    - 无需确认的“全自动自治”（把关键动作的确认/可撤销机制跑通后再做）
    - 版本 diff/对比（逐字段高亮）、自动挑选“最佳版本”
    - 自动清理策略（按空间阈值/按时间）与存储配额管理（先把“手动可控清理”做好）
- 非目标（明确不做）：
  - 不把本期做成“网站形态”的交互假设（它是桌面应用；UI 技术栈是 Web 只是实现方式）。
  - 不做复杂排期/预算/人员协作等项目管理系统。
  - 不承诺 AI 输出“绝对正确/一次到位”，本期更关注可控、可迭代、可沉淀。

## 用户故事 / 使用场景

- 作为摄影工作室主理人，我想把常用拍摄场景/道具/服装整理成资产，以便后续快速复用并保持风格一致。
- 作为运营/助理，我想在上传资产图片后由 AI 自动生成描述与标签（我确认后保存），以便减少整理时间并提升检索效率。
- 作为摄影师/修图师，我想对资产图片做通用的 AI 编辑（例如去除干扰物/统一背景/生成更干净的资产图），以便资产库更可用、风格更统一。
- 作为创意/策划，我想在创建新项目时从资产库快速拼接上下文，让 AI 生成新的创意方案，以便减少从 0 到 1 的时间。
- 作为策划/客户对接，我想在生成方案时就能看到每个分镜的预览图（哪怕是低清预览），以便快速判断方向并决定是否继续细化。
- 作为执行摄影师，我想在项目里查看并调整分镜与镜头建议（必要时让 AI 给出改动建议），以便更快进入可拍摄状态。
- 作为任何角色，我想用全局 AI Chat 直接“对应用下达指令”（创建/修改资产、创建项目、选择配置、触发生成），以便不必在多层页面里来回点选。（Phase B）
- 作为重度用户，我想所有生成的版本（方案与图片）都有历史记录，并且我可以随时删除我不想要的版本来释放空间。
- 作为内容/修图人员，我想在每张生成图片旁边直接看到“这张图的 effective prompt”，我可以编辑它并一键重新生成，从而快速迭代到满意版本。

## 交互与流程

- 入口（信息架构建议，便于后续拆分路由/页面）：
  - 项目（Projects）：列表 / 新建 / 详情（流程式配置与生成）
  - 资产（Assets）：场景 / 道具 / 服装 / 提示词预设
  - 设置（Settings）：AI Provider、模型选择、存储位置等（本地优先）
- 主流程（High Level）：
  1. 用户维护资产库（可先做“场景”最小闭环，再扩展到道具/服装/提示词预设）：
     - 新建资产 → 上传图片（可选）→（可选）使用 AI 生成描述/标签/要点 → 用户确认 → 保存
     -（可选）对资产图片进行 AI 编辑 → 保存为“资产图片新版本/衍生图”（保留原图）
  2. 用户以“项目流程”方式创建方案：
     - 新建项目 → 在固定步骤 UI 中选择场景/道具/服装/提示词预设 → 点击“生成创意方案”
  3. AI 生成完成后进入“方案查看”（默认生成一个新版本）：
     - 展示结构化内容（如：主题/创意思路/分镜列表/镜头建议/提示词）
     - 自动触发“预览图生成”（可配置为：不自动 / 只生成封面+前 N 张 / 生成全部）
       - 由于会额外消耗额度，**首次自动触发前必须让用户选择策略并可记住**（见 ADR 0003）
       - 默认策略若为“封面+前 N 张”，本期固定 `N=3`（N 不含封面）
     - 预览图生成需支持：进度、取消、失败重试；生成完成后在方案里可见
     - 该次生成作为“方案版本”保存，可回到历史版本查看/切换
  4. AI 贯穿（全局 + 项目内，Phase B）：
     - 全局 AI Chat（Agent）：用户用自然语言描述目标（“帮我创建一个项目…并生成方案”），AI 产出计划并调用后端 API 执行（执行前需用户确认关键动作）。
     - 项目内 AI 助手：围绕当前项目上下文进行问答与调整建议，并可通过 skills 将建议落地为可见的配置/内容变更（同样遵循确认机制）。

- 通用 AI 能力插入点（跨模块复用）：
  - 资产详情页：
    - “AI 生成描述/标签”：基于图片 + 用户补充信息生成可编辑草稿，用户确认后写入资产字段
    - “AI 图片生成/编辑”（通用组件，Lite；不在 Chat 气泡里直接改图）：
      - 组件需要保留“提示词上下文”（资产信息/项目风格/用户指令），并以当前流程的表单/控件形态呈现（弱化但贴合流程）
      - 组件需要展示 effective prompt（系统拼接后的最终提示词）并允许用户编辑；编辑后的提示词可直接重新生成并形成新版本
      - 组件提供编辑、重新编辑、重新生成等基础能力
      - 每一次生成/编辑都创建新版本（不覆盖原图），用户可在 UI 里选择设为主图或删除
  - 资产列表页（可选，MVP 视工期）：
    - 批量生成标签/描述（选择多条资产 → AI 批处理 → 人工确认后应用）
  - 项目流程页：
    - 在每一步提供“让 AI 推荐/补全”的入口（例如推荐更合适的场景/提示词预设）
  - 全局（Phase B）：
    - AI Chat 既能回答问题，也能“执行动作”（skills）；执行动作必须可观察（执行记录/结果回显）且尽量可撤销
  - 版本管理（贯穿所有生成类动作）：
    - 所有生成操作默认创建“新版本”，不会直接覆盖用户现有内容
    - UI 需要提供“当前版本”与“历史版本”入口；并提供删除/清理能力
    - 清理的对象包含：DB 记录 + 本地文件（图片/附件）；删除需二次确认（尤其是删除当前版本）
- 异常/边界流程（桌面端 + AI 常见问题）：
  - 未配置 Provider / 无 API Key：
    - 资产管理与项目管理仍可用；
    - 点击“生成方案”时提示原因，并引导去设置完成配置（或提示可用的本地/离线能力边界）。
  - AI 请求超时/失败：
    - 显示可理解错误信息与重试入口；不丢失用户已选资产与已填写信息。
  - 本地文件读写失败（无权限/磁盘满/路径不可用）：
    - 上传图片/写入数据库失败时提示原因与可恢复操作（更换路径/清理空间/重试）。
  - AI skills 执行失败/部分失败：
    - 展示“哪一步失败 + 原因 + 是否已产生部分变更”，并支持重试或回滚到执行前状态（MVP 可先保证“执行前确认 + 执行后可见变更摘要”）。

## 数据与接口影响

- 新增/修改的数据结构（引用 `docs/engineering/contracts.md`）：
  - 需要在契约文档中正式定义（或补齐）以下“长期稳定”的对象：
    - Asset：`Scene / Prop / Outfit / PromptPreset`（最小字段：`id/name/description/tags/images[]/createdAt/updatedAt`）
    - Project：项目选择了哪些资产、当前步骤状态、生成历史（最小字段：`id/title/selectedAssets/createdAt/updatedAt`）
    - CreativePlan（创意方案）：结构化输出（建议版本化，至少能回溯最近 N 次生成）
    - AI 对话与执行记录：
      - GlobalChat / ProjectChat：对话会话与消息（MVP 可先只持久化最近 N 条或只持久化摘要）
      - SkillExecutionLog：AI 调用 skills 的执行记录（包含输入、执行结果、涉及的资源 ID、错误信息、时间戳）
    - 资产 AI 辅助字段（建议最小化、可追溯）：
      - `aiDraftDescription/aiDraftTags`（草稿，需用户确认后写回 `description/tags`）
      - `derivedImages[]`（AI 编辑产生的衍生图，保存本地路径与来源信息）
    - 统一的“生成版本/产物”模型（建议所有生成类动作都落到同一套抽象）：
      - GenerationRun：一次生成动作（谁触发、何时、输入快照、使用的 provider/model、参数）
      - GenerationArtifact：生成产物（文本/图片/JSON/文件），以“文件路径 + 元信息”方式存储，避免 base64 直接入库
        - 图片产物建议附带：
          - effectivePrompt：含上下文拼接后的最终 prompt（UI 必须可编辑与复用）
          - promptContext：结构化上下文快照（用于解释、版本对比与“修改上下文”）
          - editInstruction / referenceImages / parentArtifactId：用于重新编辑与谱系追踪
      - ActivePointer：每个对象（项目/方案/资产）需要一个“当前版本”指针，历史版本以追加方式保留
  - 新增/修改的 API（引用 `docs/engineering/api.md`）：
  - 资产 CRUD：需要覆盖场景/道具/服装/提示词预设（可分阶段交付，先场景闭环）。
  - 项目 CRUD：创建/更新/删除/获取详情；记录已选资产与方案历史。
  - 生成方案：
    - 输入：项目上下文（标题/已选资产/提示词预设等）
    - 输出：结构化 CreativePlan（并与项目关联、可回溯）
  - 通用 AI 能力（跨模块）：
    - 资产图片理解（生成描述/标签/要点）：输入图片与可选的用户补充信息；输出结构化字段草稿
    - AI 图片生成/编辑（支撑通用组件）：
      - 输入：referenceImages（可选）+ promptContext（结构化）+ effectivePrompt（可编辑字符串）+ editInstruction（可选）+ 生成参数
      - 输出：新的图片文件（建议走任务队列以支持取消/重试/进度），并回显 effectivePrompt + promptContext + artifactId/parentArtifactId（用于版本管理与可解释性）
  - AI Agent / Skills（重点）：
    - AI Chat 需要一个“可受控执行”的后端入口：模型产出 skills 调用 → 后端校验权限与参数 → 调用内部 API（资产/项目/生成）→ 返回结果给 Chat
    - skills 需要注册表（名称/描述/输入 schema/权限范围/是否可批量/是否需要二次确认），类似 Claude Code skills
    - “面向 UI + 面向 AI”的双通道一致性：同一个后端能力（如创建资产、生成图片、切换版本）既能被 UI 直接调用，也能被 AI 通过 skills 以结构化方式调用
      - UI 不依赖“录制点击/自动点按钮”，而是调用同一套 command API；AI 调用的也是这套 command API（或其受控封装）
  - 预览图生成（方案生成的一部分）：
    - 支持在“生成方案”后自动触发预览图生成（按场景/按封面）
    - 预览图需要走任务队列并可取消；产物落到本地文件并与方案版本关联
  - 版本管理 API（建议 Sidecar 统一提供）：
    - 列表：获取某项目/某资产的版本列表（包含缩略图、时间、来源）
    - 切换：将某版本设为当前版本
    - 删除：删除一个版本（同时清理关联文件；对“当前版本”二次确认；删除当前版本后自动回退到最近版本，见 ADR 0004）
    - 清理：按条件批量清理（如保留最近 N 个版本、清理未引用文件）
- 迁移策略（如有历史数据）：
  - 旧数据结构兼容：允许旧项目缺少某些资产类型字段（如尚未做道具/服装），展示为“未配置/可补充”。
- 需要决策留痕（建议触发 ADR）：
  - “创意方案”的最小稳定结构是什么（哪些字段必须稳定以便未来导出/模板化/二次生成）？
  - AI Agent 的安全模型：skills 的权限边界、危险动作（删除/批量修改）的确认策略、可撤销/回滚的最低要求
  - Image Studio（Lite/Pro）的能力边界：哪些上下文项在流程 UI 内可编辑，哪些交给 Chat/高级模式；以及默认预览图生成策略（封面+N / 全场景）

## 验收标准

### Success Criteria（至少 3 条，可验证）

> 说明：本次实现优先跑通 Phase A（流程内 Lite 闭环）。Phase B（全局 AI/skills）不阻塞 Phase A，可在后续里程碑独立验收。

- [ ] 本地优先 / 开箱即用：首次启动无需登录；在无网络情况下仍可完成资产与项目的创建/编辑/查看（AI 相关能力允许降级或提示不可用）。
- [ ] 资产管理可用：用户可对至少 1 类资产（场景）完成完整 CRUD，并支持标签/关键词检索；资产可被项目选择引用。
- [ ] 资产 AI 辅助可用：对包含图片的资产，用户可一键生成“描述/标签”草稿并在确认后写入；该过程可重试且不覆盖用户手填内容。
- [ ] 通用图片生成/编辑组件（Lite）可用：在任意“需要出图”的页面复用；展示 effective prompt 并可编辑/复用；支持重新生成/重新编辑；每次动作创建新版本且原图保留。
- [ ] effective prompt 一致性：用户点击“生成/重新生成”后，组件内展示的 effective prompt 与服务端实际使用并回显的 prompt 一致（避免 UI 显示与实际出图不一致）。
- [ ] 项目流程可用：用户可创建项目、按固定步骤选择资产与提示词预设，并触发一次 AI 生成；生成结果以结构化方案展示并可保存为项目历史版本。
- [ ] 方案预览图可用：生成方案后能自动生成预览图（至少覆盖“封面+前 N 张”或“全场景低清预览”的一种策略）；生成过程有进度、可取消、失败可重试。
- [ ] 自动预览图首次授权：第一次触发“生成方案后自动生成预览图”前，必须明确告知张数与可能消耗额度，并允许用户记住选择（后续可在设置修改）。
- [ ] 可迭代不丢状态：AI 生成失败后，用户不需要重新选择资产；可直接重试或调整输入后再次生成。
- [ ] （Phase B）全局 AI Chat（Agent）可执行：用户可用自然语言触发至少一组可落地的 skills（如创建项目、更新资产标签、触发生成）；执行前有确认，执行后结果在 UI 可见。
- [ ] 版本管理可用：对“方案生成”和“资产图片生成/编辑”都会生成可回溯版本；用户可以切换当前版本、删除单个版本，并能看到清理后释放空间的反馈（最小可用）。
- [ ] 任务队列可追溯：任务队列保留失败与完整历史，失败任务可从任务队列直接重试（见 ADR 0005）。

### Failure Scenarios（至少 2 条，可理解且可恢复）

- [ ] 未配置 Provider / 无 API Key：点击“生成方案”时提示“需要配置 AI Provider”，并提供直达设置页的可恢复路径；不影响资产库与项目管理。
- [ ] AI 生成超时/返回错误：展示失败原因（可读文案），并提供“重试/取消”入口；失败不会覆盖或破坏已有方案历史。
- [ ] AI 图片编辑/理解能力不可用（模型不支持/返回错误）：给出原因与替代路径（跳过 AI、手动填写/手动编辑），不阻塞保存资产与继续项目流程。
- [ ] 本地存储失败（磁盘满/无权限）：在上传图片或写入数据失败时提示原因，并给出可操作建议（更换目录/释放空间/重试）。
- [ ] （Phase B）skills 执行出现部分失败：展示执行记录与已变更内容，允许用户选择“重试失败步骤”或“放弃并保留已完成的部分变更”；对危险动作始终要求二次确认。
- [ ] 版本清理误操作：删除当前版本/批量清理前必须二次确认，并明确告知“将删除哪些版本/文件、是否可恢复”；删除当前版本时明确告知“将自动回退到最近版本；若无则进入空状态”（见 ADR 0004）；批量清理至少提供“取消”与“排除当前版本”的安全选项。

## 风险与回滚

- 风险：
  - 范围膨胀：资产类型（场景/道具/服装/提示词）+ 项目流程 + AI 生成 + 方案版本化，容易超出 MVP。
  - AI 输出不稳定：若没有“结构化契约 + 校验”，容易导致展示与后续能力（导出/模板化）受阻。
  - Agent 风险：skills 调用若缺少确认/权限/可观测性，容易造成“AI 擅自改动”带来的不信任与数据损坏。
  - 版本管理的 UI/存储复杂度：版本会迅速膨胀（尤其图片），若缺少“可视化的历史/当前指针/清理入口/空间反馈”，用户会困惑或占满磁盘。
  - 桌面端本地文件/权限差异：不同系统的路径、权限、磁盘状态会影响稳定性。
- 回滚方案：
  - 若 AI 生成不稳定：先保留“资产库 + 项目配置”主链路，AI 能力降级为“生成草案文本”或仅提供建议，不阻塞日常使用。
  - 若 skills 风险过高：提供“只读对话模式”（AI 只能建议不执行），或将执行能力限定为少数安全 skills（创建/只增不删），逐步放开。
  - 若版本管理 UI 过重：先保证“版本在数据层完整记录 + 可删除清理”，UI 先提供“最近版本列表 + 设为当前 + 删除”，延后 diff/对比与高级清理策略。
  - 若某些资产类型复杂：先只交付“场景”闭环，其他类型先以“备注/标签”形式挂在项目里，后续再拆分为独立资产表。
